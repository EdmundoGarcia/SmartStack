{% extends "layouts/base_user.html" %}
{% block title %}Mi Wishlist - SmartStack{% endblock %}
{% block user_content %}

<h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Libros en tu wishlist</h2>

{% if not is_empty %}
  <form id="wishlist-search-form" class="mb-4 flex flex-wrap gap-2 items-center">
    <input
      type="text"
      name="search"
      placeholder="Buscar por título o autor"
      class="flex-grow px-3 py-2 border rounded-md dark:bg-slate-700 dark:text-white"
    />
    <select name="sort" class="px-2 py-2 border rounded-md dark:bg-slate-700 dark:text-white">
      <option value="recent">Más recientes</option>
      <option value="oldest">Primeros agregados</option>
      <option value="title_asc">Título A-Z</option>
      <option value="title_desc">Título Z-A</option>
    </select>
  </form>

  <p id="wishlist-counter" class="text-sm text-gray-600 dark:text-gray-300 mb-2"></p>

  <div id="books-wrapper" data-total="{{ total }}" data-page="{{ page }}" data-per-page="{{ per_page }}">
    <div id="books-grid"></div>
    <div id="books-pagination"></div>
  </div>
{% else %}
  <div class="text-center py-12 text-gray-600 dark:text-gray-300">
    <p class="text-lg mb-2">Tu wishlist está vacía por ahora.</p>
    <p>Agrega libros desde la búsqueda o recomendaciones para comenzar.</p>
  </div>
{% endif %}

{% if not is_empty %}
<script>
  const form = document.getElementById("wishlist-search-form");
  const searchInput = form.querySelector('input[name="search"]');
  const sortSelect = form.querySelector('select[name="sort"]');
  const wrapper = document.getElementById("books-wrapper");
  const gridContainer = document.getElementById("books-grid");
  const paginationContainer = document.getElementById("books-pagination");
  const counter = document.getElementById("wishlist-counter");

  let debounceTimer;
  let currentPage = parseInt(wrapper.dataset.page || "1");

  function fetchWishlist() {
    const query = searchInput.value;
    const sort = sortSelect.value;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      fetch(`/wishlist/search?search=${encodeURIComponent(query)}&sort=${sort}&page=${currentPage}`)
        .then(res => res.text())
        .then(html => {
          const temp = document.createElement("div");
          temp.innerHTML = html;

          const newGrid = temp.querySelector("#books-grid");
          const newPagination = temp.querySelector("#books-pagination");
          const newWrapper = temp.querySelector("#books-wrapper");

          if (newGrid) gridContainer.innerHTML = newGrid.innerHTML;
          if (newPagination) paginationContainer.innerHTML = newPagination.innerHTML;
          if (newWrapper) {
            wrapper.dataset.total = newWrapper.dataset.total;
            wrapper.dataset.page = newWrapper.dataset.page;
            wrapper.dataset.perPage = newWrapper.dataset.perPage;
          }

          updateCounter();
        });
    }, 250);
  }

  function changePage(page) {
    currentPage = page;
    wrapper.dataset.page = page;
    fetchWishlist();
  }

  function updateCounter() {
    const total = parseInt(wrapper.dataset.total || "0");
    const page = parseInt(wrapper.dataset.page || "1");
    const perPage = parseInt(wrapper.dataset.perPage || "12");

    const visible = gridContainer.querySelectorAll(".wishlist-card").length;
    const start = (page - 1) * perPage + 1;
    const end = start + visible - 1;

    if (total > 0 && visible > 0) {
      counter.textContent = `Mostrando ${start}–${end} de ${total}`;
    } else {
      counter.textContent = "";
    }
  }

  searchInput.addEventListener("input", () => {
    currentPage = 1;
    wrapper.dataset.page = "1";
    fetchWishlist();
  });

  sortSelect.addEventListener("change", () => {
    currentPage = 1;
    wrapper.dataset.page = "1";
    fetchWishlist();
  });

  document.addEventListener("DOMContentLoaded", () => {
    fetchWishlist();
  });
</script>
{% endif %}
{% endblock %}
