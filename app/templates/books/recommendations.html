{% extends "layouts/base.html" %}
{% block title %}Recomendaciones{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6 text-center">
  <h1 class="text-2xl font-semibold mb-6">Recomendaciones personalizadas</h1>

  {% if not show_recommendation_ui %}
    <div class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 p-4 rounded text-sm max-w-xl mx-auto">
      Agrega al menos <strong>3 libros</strong> a tu biblioteca para recibir recomendaciones.
    </div>
  {% else %}
    <style>
      .chip input[type="radio"]:checked + span {
        background-color: #2563eb;
        color: white;
        border-color: #2563eb;
      }
    </style>

    <div class="flex flex-wrap justify-center gap-2 mb-4" id="category-chips">
      {% for cat in user_categories %}
      <label class="chip cursor-pointer">
        <input type="radio" name="selected_category" value="{{ cat }}" class="hidden" />
        <span class="px-3 py-1 rounded-full border text-sm bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-blue-100 dark:hover:bg-blue-700 transition">
          {{ cat }}
        </span>
      </label>
      {% endfor %}
    </div>

    <button onclick="fetchRecommendationsWithFilters()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-4">
      Mostrar recomendaciones
    </button>

    <div id="loader" class="hidden text-gray-500 dark:text-gray-300 text-sm mb-4">
      Cargando recomendaciones...
    </div>

    <div id="recommendations" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
  {% endif %}

  <script>
    const ROUTES = {
      toggleLibrary: "{{ url_for('books.toggle_library') }}",
      toggleWishlist: "{{ url_for('books.toggle_wishlist') }}"
    };

    function submitForm(route, data) {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = route;
      for (const key in data) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = String(data[key] || "");
        form.appendChild(input);
      }
      document.body.appendChild(form);
      form.submit();
    }

    function fetchRecommendationsWithFilters() {
      const selectedCategory = document.querySelector('input[name="selected_category"]:checked')?.value;
      const params = new URLSearchParams();
      if (selectedCategory) {
        params.append("selected_category", selectedCategory);
      } else {
        document.getElementById("recommendations").innerHTML = `
          <div class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 p-4 rounded text-sm col-span-full">
            Selecciona una categoría para recibir recomendaciones.
          </div>
        `;
        return;
      }

      document.getElementById("loader").classList.remove("hidden");
      fetch("/recommendations/fetch?" + params.toString())
        .then(res => res.json())
        .then(data => {
          document.getElementById("loader").classList.add("hidden");

          if (data.error === "Perfil insuficiente") {
            document.getElementById("recommendations").innerHTML = `
              <div class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 p-4 rounded text-sm col-span-full">
                Agrega al menos <strong>3 libros</strong> a tu biblioteca para recibir recomendaciones.
              </div>
            `;
            return;
          }

          renderRecommendations(data);
        })
        .catch(err => {
          document.getElementById("loader").classList.add("hidden");
          document.getElementById("recommendations").innerHTML = `
            <div class="bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-200 p-4 rounded text-sm col-span-full">
              Ocurrió un error al obtener recomendaciones. Intenta nuevamente.
            </div>
          `;
          console.error("Error al obtener recomendaciones:", err);
        });
    }

    function renderBookCard(book) {
      if (!book.google_id) return "";

      const categories = Array.isArray(book.categories)
        ? book.categories.join(", ")
        : book.categories || "";

      return `
        <div class="bg-white dark:bg-gray-900 shadow rounded-lg p-4 flex flex-col transition hover:shadow-xl">
          <a href="/book/${book.google_id}" class="block group">
            ${
              book.thumbnail
                ? `<div class="w-full h-48 sm:h-56 md:h-64 mb-3 overflow-hidden rounded flex items-center justify-center bg-gray-100 dark:bg-gray-800">
                    <img src="${book.thumbnail}" alt="${book.title}" class="max-h-full max-w-full object-contain group-hover:scale-105 transition-transform duration-300">
                  </div>`
                : `<div class="aspect-w-2 aspect-h-3 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-sm text-gray-400 dark:text-gray-500 italic mb-3 rounded">
                    Sin portada disponible
                  </div>`
            }
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-1 hover:text-blue-600 dark:hover:text-blue-400 transition">
              ${book.title}
            </h2>
          </a>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">${book.authors}</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
            Idioma: ${book.language} &nbsp;|&nbsp; Similitud: ${book.similarity}
          </p>

          <div class="flex justify-between mb-2">
            <button onclick='submitForm("${ROUTES.toggleLibrary}", {
              book_id: "${book.google_id}",
              title: "${book.title}",
              authors: "${book.authors}",
              language: "${book.language}",
              thumbnail: "${book.thumbnail || ""}",
              isbn: "${book.isbn || ""}",
              categories: "${categories}",
              submitted: "${Math.floor(Math.random() * 1000000)}"
            })' class="text-primary hover:scale-110 transition" title="Agregar a biblioteca">
              <i class="far fa-bookmark fa-lg"></i>
            </button>

            <button onclick='submitForm("${ROUTES.toggleWishlist}", {
              book_id: "${book.google_id}",
              title: "${book.title}",
              authors: "${book.authors}",
              language: "${book.language}",
              thumbnail: "${book.thumbnail || ""}",
              isbn: "${book.isbn || ""}",
              categories: "${categories}",
              submitted: "${Math.floor(Math.random() * 1000000)}"
            })' class="text-red-500 hover:scale-110 transition" title="Agregar a wishlist">
              <i class="far fa-heart fa-lg"></i>
            </button>
          </div>

          ${renderQuickView(book)}
        </div>
      `;
    }

    function renderQuickView(book) {
      return `
        <div x-data="{
          open: false,
          toggleScroll(value) {
            document.body.classList.toggle('overflow-hidden', value);
          }
        }" @keydown.escape.window="open = false" x-effect="toggleScroll(open)">
          <button @click="open = true" class="text-sm text-blue-600 dark:text-blue-400 hover:underline" aria-label="Vista rápida del libro">Vista rápida</button>

          <template x-if="open">
            <div @click.self="open = false" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg max-w-md w-full p-6 relative overflow-y-auto max-h-[90vh]">
                <button @click="open = false" class="absolute top-2 right-2 text-gray-500 hover:text-red-500">
                  <i class="fas fa-times"></i>
                </button>

                ${
                  book.thumbnail
                    ? `<img src="${book.thumbnail}" alt="Portada" class="w-full h-64 object-contain mb-4" />`
                    : ""
                }

                <h3 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">
                  <a href="/book/${book.google_id}" class="hover:underline text-blue-700 dark:text-blue-400">${book.title}</a>
                </h3>

                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Autor: ${book.authors}</p>
                              <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Idioma: ${book.language}</p>
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">ISBN: ${book.isbn || "N/A"}</p>

              ${
                book.description
                  ? `<p class="text-sm text-gray-700 dark:text-gray-400 mt-2 whitespace-pre-line">${book.description}</p>`
                  : ""
              }

              <div class="mt-4 text-sm text-gray-500 dark:text-gray-400 italic">
                Puedes agregar este libro desde la tarjeta principal.
              </div>
            </div>
          </div>
        </template>
      </div>
      `;
    }

    function renderRecommendations(data) {
      const container = document.getElementById("recommendations");
      container.innerHTML = "";

      if (data.books && data.books.length > 0) {
        const threshold = 0.3;
        const highSimilarityBooks = data.books.filter(
          (book) => book.similarity >= threshold
        );
        const lowSimilarity = highSimilarityBooks.length === 0;
        const booksToShow = lowSimilarity ? data.books : highSimilarityBooks;

        if (lowSimilarity) {
          container.innerHTML += `
            <div class="col-span-full text-sm text-gray-600 dark:text-gray-300 mb-4">
              Mostrando libros con similitud parcial a tu perfil. Puedes afinar las recomendaciones agregando más libros o explorando nuevos géneros.
            </div>
          `;
        }

        booksToShow.forEach((book) => {
          container.innerHTML += renderBookCard(book);
        });
      } else {
        container.innerHTML = `
          <div class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 p-4 rounded text-sm col-span-full">
            No se encontraron recomendaciones relevantes en este momento. Intenta más tarde o agrega más libros a tu biblioteca.
          </div>
        `;
      }
    }
  </script>
</div>
{% endblock %}
