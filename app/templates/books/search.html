{% extends "layouts/base_user.html" %}
{% block title %}
  {% if query %}
    Resultados para "{{ query }}" - SmartStack
  {% elif author %}
    Libros escritos por "{{ author }}" - SmartStack
  {% elif publisher %}
    Libros publicados por "{{ publisher }}" - SmartStack
  {% else %}
    Resultados de búsqueda - SmartStack
  {% endif %}
{% endblock %}

{% block user_content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Filters -->
  <aside class="lg:col-span-1 bg-white dark:bg-slate-800 p-4 rounded shadow text-gray-800 dark:text-white">
    <form method="GET" action="{{ url_for('books.search_books') }}" class="space-y-4">
      <input type="hidden" name="q" value="{{ query }}">

      <div>
        <label class="font-semibold">Idioma:</label><br>
        <label><input type="checkbox" name="lang" value="en" {% if 'en' in lang_filters %}checked{% endif %}> Inglés</label><br>
        <label><input type="checkbox" name="lang" value="es" {% if 'es' in lang_filters %}checked{% endif %}> Español</label>
      </div>

      <div>
        <label class="font-semibold">Autor:</label>
        <input type="text" name="author" value="{{ author }}" class="w-full px-2 py-1 border rounded bg-gray-100 dark:bg-slate-700 dark:text-white">
      </div>

      <div>
        <label class="font-semibold">Editorial:</label>
        <input type="text" name="publisher" value="{{ publisher }}" class="w-full px-2 py-1 border rounded bg-gray-100 dark:bg-slate-700 dark:text-white">
      </div>

      <div>
        <label class="font-semibold">Ordenar por:</label>
        <select name="order" class="w-full px-2 py-1 border rounded bg-gray-100 dark:bg-slate-700 dark:text-white">
          <option value="relevance" {% if order_by == 'relevance' %}selected{% endif %}>Relevancia</option>
          <option value="newest" {% if order_by == 'newest' %}selected{% endif %}>Más recientes</option>
        </select>
      </div>

      <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Aplicar filtros</button>
    </form>
  </aside>

  <!-- Results -->
  <section class="lg:col-span-3">
    <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">
      {% if query %}
        Resultados para: "{{ query }}"
      {% elif author %}
        Libros escritos por: "{{ author }}"
      {% elif publisher %}
        Libros publicados por: "{{ publisher }}"
      {% else %}
        Resultados de búsqueda
      {% endif %}
    </h2>

    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
      Se encontraron <strong>{{ total_items }}</strong> libros en los idiomas seleccionados.
    </p>

    {% if results %}
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for item in results %}
          {% set book = search_cache[item.id] %}
          {% set book = book.update({'id': item.id}) or book %}
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden flex flex-col">
            <a href="{{ url_for('books.book_detail', id=book.id) }}" class="w-full h-64 bg-gray-100 dark:bg-slate-700 flex items-center justify-center hover:opacity-90 transition">
              {% if book.thumbnail %}
                <img src="{{ book.thumbnail }}" alt="Portada" class="max-h-60 object-contain" />
              {% else %}
                <div class="flex items-center justify-center h-40 bg-gray-100 dark:bg-slate-700 text-gray-400 dark:text-gray-500 text-sm italic">
                  Sin portada disponible
                </div>
              {% endif %}
            </a>

            <div class="p-4 flex flex-col justify-between flex-grow">
              <div>
                <h3 class="font-semibold text-base mb-1 line-clamp-2">
                  <a href="{{ url_for('books.book_detail', id=book.id) }}" class="hover:underline text-blue-700 dark:text-blue-400">{{ book.title }}</a>
                </h3>
                <p class="text-xs text-gray-600 dark:text-gray-300 mb-1">{{ book.authors | join(', ') }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Idioma: {{ book.language or 'N/A' }}</p>
              </div>

              <div class="mt-4 flex justify-start gap-6 items-center">
                <!-- Biblioteca -->
                <form method="POST" action="{{ url_for('books.add_to_library') }}">
                  <input type="hidden" name="book_id" value="{{ book.id }}">
                  <input type="hidden" name="title" value="{{ book.title }}">
                  <input type="hidden" name="authors" value="{{ book.authors | join(', ') }}">
                  <input type="hidden" name="language" value="{{ book.language }}">
                  <input type="hidden" name="thumbnail" value="{{ book.thumbnail }}">
                  <input type="hidden" name="isbn" value="{{ book.isbn }}">
                  <!-- <input type="hidden" name="categories" value="{{ book.categories | join(', ') }}">
                    -->
                  <input type="hidden" name="categories" value="{% if book.categories is iterable and book.categories is not string %}{{ book.categories | join(', ') }}{% else %}{{ book.categories }}{% endif %}">
                  <input type="hidden" name="submitted" value="{{ range(1000000)|random }}">
                  <button type="submit" class="hover:scale-110 transition" title="Agregar a biblioteca">
                    {% if library_ids and book.id in library_ids %}
                      <i class="fas fa-bookmark fa-lg" title="Ya en biblioteca"></i>
                    {% else %}
                      <i class="far fa-bookmark fa-lg" title="Agregar a biblioteca"></i>
                    {% endif %}
                  </button>
                </form>

                <!-- Wishlist -->
                <form method="POST" action="{{ url_for('books.add_to_wishlist') }}">
                  <input type="hidden" name="book_id" value="{{ book.id }}">
                  <input type="hidden" name="title" value="{{ book.title }}">
                  <input type="hidden" name="authors" value="{{ book.authors | join(', ') }}">
                  <input type="hidden" name="language" value="{{ book.language }}">
                  <input type="hidden" name="thumbnail" value="{{ book.thumbnail }}">
                  <input type="hidden" name="isbn" value="{{ book.isbn }}">
                  <input type="hidden" name="categories" value="{{ book.categories | join(', ') }}">
                  <input type="hidden" name="submitted" value="{{ range(1000000)|random }}">
                  <button type="submit" class="hover:scale-110 transition" title="Agregar a wishlist">
                    {% if wishlist_ids and book.id in wishlist_ids %}
                      <i class="fas fa-heart fa-lg" title="Ya en wishlist"></i>
                    {% else %}
                      <i class="far fa-heart fa-lg" title="Agregar a wishlist"></i>
                    {% endif %}
                  </button>
                </form>

                <!-- Vista rápida -->
                {% include "components/quick_view_modal.html" %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center space-x-2">
        {% for p in range(1, total_pages + 1) %}
          <a href="{{ url_for('books.search_books', q=query, page=p, order=order_by, author=author, publisher=publisher, lang=lang_filters) }}"
             class="px-3 py-1 rounded border font-semibold
                    {% if p == page %}
                      bg-primary text-white
                    {% else %}
                      bg-white dark:bg-slate-700 text-primary dark:text-white hover:bg-gray-100 dark:hover:bg-slate-600
                    {% endif %}">
            {{ p }}
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-gray-600 dark:text-gray-300 mt-10">No se encontraron resultados en los idiomas seleccionados.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
